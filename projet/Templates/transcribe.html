{% extends "base.html" %}
{% load static %}

{% block title %}Voice-to-Text{% endblock %}

{% block css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;600;700&family=Space+Grotesk:wght@400;600;700&display=swap');

    :root {
        --paper: #f7f2ea;
        --accent: #ff7a18;
        --accent-3: #ffb347;
        --card: rgba(255, 255, 255, 0.72);
        --shadow: 0 24px 60px rgba(16, 18, 26, 0.18);
    }

    body {
        background: radial-gradient(1200px 500px at 10% -10%, #ffe7c6 0%, transparent 60%),
                    radial-gradient(800px 400px at 90% 10%, #d9fff7 0%, transparent 55%),
                    var(--paper);
        color: var(--ink);
        font-family: 'IBM Plex Sans Arabic', 'Space Grotesk', sans-serif;
    }

    .transcribe-page {
        position: relative;
        overflow: hidden;
    }

    .transcribe-section {
        padding-top: 140px;
        padding-bottom: 60px;
    }

    .hero-title {
        font-size: clamp(26px, 4vw, 38px);
        font-weight: 700;
        letter-spacing: 0.2px;
    }

    .hero-sub {
        opacity: 0.75;
        margin-top: 6px;
        font-size: 16px;
    }

    .glass-card {
        background: var(--card);
        border: 1px solid var(--stroke);
        border-radius: 22px;
        padding: 24px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        animation: fade-up 0.6s ease both;
    }

    .card-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 12px;
    }

    .transcribe-actions {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        margin-top: 16px;
    }

    .transcribe-actions .main-button {
        border: 0;
        cursor: pointer;
        background: linear-gradient(135deg, var(--accent), var(--accent-3));
        color: #1c1208;
        font-weight: 700;
        padding: 12px 18px;
        border-radius: 14px;
        box-shadow: 0 10px 20px rgba(255, 122, 24, 0.25);
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }

    .transcribe-actions .main-button:disabled {
        filter: grayscale(0.4);
        opacity: 0.6;
        box-shadow: none;
        cursor: not-allowed;
    }

    .transcribe-actions .main-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 16px 30px rgba(255, 122, 24, 0.35);
    }

    .text-input {
        padding: 12px 14px;
        width: min(100%, 360px);
        font-size: 16px;
        margin: 10px auto 0;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.9);
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .text-input:focus {
        border-color: var(--accent-2);
        box-shadow: 0 0 0 4px rgba(43, 179, 177, 0.2);
    }

    .divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(16, 18, 26, 0.2), transparent);
        margin: 24px 0;
        border: 0;
    }

    .sign-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 18px;
        margin-top: 18px;
    }

    .sign-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 18px;
        padding: 12px;
        border: 1px solid var(--stroke);
        text-align: center;
        box-shadow: 0 14px 28px rgba(16, 18, 26, 0.12);
    }

    .sign-card img {
        width: 100%;
        height: 260px;
        object-fit: cover;
        border-radius: 14px;
        background: #fff;
        box-shadow: 0 10px 18px rgba(16, 18, 26, 0.15);
    }

    .pill {
        display: inline-block;
        margin-top: 8px;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 700;
        background: rgba(16, 18, 26, 0.06);
    }

    .result-box {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        padding: 14px;
        border: 1px solid var(--stroke);
        white-space: pre-wrap;
    }

    @keyframes fade-up {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
        .glass-card { padding: 18px; }
        .sign-card img { height: 200px; }
    }
</style>
{% endblock %}

{% block content %}

    <div class="transcribe-page">

    <!-- ***** Header ***** -->
   

    <!-- ***** Section Enregistrement ***** -->
    <section class="section transcribe-section" id="record">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 offset-lg-3">
                    <div class="text-center glass-card">
                        <h2 class="hero-title">ðŸŽ¤ Record Audio and Convert to Text</h2>
                        <p class="hero-sub">Start recording from the microphone, then send it for transcription.</p>

                        <div class="transcribe-actions">
                            <button id="start" class="main-button">Start Recording</button>
                            <button id="stop" class="main-button" disabled>Stop Recording</button>
                        </div>

                        <p id="status" class="mt-2"></p>

                        <form id="uploadForm" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="file" name="audio" id="audioFile" hidden>
                            <div class="transcribe-actions">
                                <button type="submit" class="main-button">Send Audio for Transcription</button>
                            </div>
                        </form>

                        <hr class="divider">
                        <h3 class="card-title">ðŸ”¤ Or Type a Word</h3>
                        <form method="post">
                            {% csrf_token %}
                            <input type="text" name="text_input" class="text-input" placeholder="Type a word (Arabic or Latin)">
                            <div class="transcribe-actions">
                                <button type="submit" class="main-button">Show Sign</button>
                            </div>
                        </form>

                        {% if sign_images %}
                            <div style="margin-top: 20px;">
                                <h4 class="card-title">Signs for Words:</h4>
                                <div class="sign-grid">
                                    {% for item in sign_images %}
                                        <div class="sign-card">
                                            <img src="{{ item.image }}" alt="Sign for {{ item.word }}">
                                            <div class="pill">{{ item.word }}</div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% elif translit %}
                            <p style="color: red; margin-top: 20px;">No words found in the sign dataset.</p>
                        {% endif %}
                        
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ***** Section RÃ©sultat ***** -->
    <section class="section" id="result">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 offset-lg-2">
                    <div class="text-center glass-card">
                        <h3 class="card-title">Extracted Text</h3>
                        <div class="result-box">{{ text }}</div>
                        <h3 class="card-title" style="margin-top: 16px;">Latin Transliteration</h3>
                        <div class="result-box">{{ translit }}</div>
                        <p style="color:red; margin-top: 12px;">{{ error }}</p>
                    </div>
                    <div style="display:flex; gap:20px; justify-content:center; align-items:center; flex-wrap: wrap; margin-top: 16px;">
                        <div id="avatar-container" style="width:300px;height:400px;"></div>
                    </div>

                </div>
            </div>
        </div>
    </section>

    </div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.avatarsdk.com/js/avatarsdk.js"></script>
<script>
  const container = document.getElementById("avatar-container");

  const avatar = new AvatarSDK.WebAvatar({
      container: container,
      width: 300,
      height: 400,
      modelUrl: "https://cdn.avatarsdk.com/models/sample_avatar.glb"  // avatar prÃ©fab
  });
</script>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        const startBtn = document.getElementById("start");
        const stopBtn = document.getElementById("stop");
        const audioFileInput = document.getElementById("audioFile");
        const status = document.getElementById("status");

        startBtn.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => {
                audioChunks.push(e.data);
            };

            mediaRecorder.onstop = e => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const file = new File([audioBlob], "recorded.webm", { type: 'audio/webm' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                audioFileInput.files = dataTransfer.files;
                status.innerText = "âœ… Recording finished. You can now send the audio.";
            };

            mediaRecorder.start();
            startBtn.disabled = true;
            stopBtn.disabled = false;
            status.innerText = "â³ Recording in progress...";
        };

        stopBtn.onclick = () => {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(t => t.stop());
            startBtn.disabled = false;
            stopBtn.disabled = true;
        };
    </script>
{% endblock %}
