{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Learning" %}{% endblock %}

{% block css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<style>
    :root {
        --ink: #1d1a14;
        --muted: rgba(29, 26, 20, 0.65);
        --paper: #fffdf7;
        --peach: #f7c7a9;
        --coral: #f06a3f;
        --teal: #0f7c7f;
        --shadow: 0 18px 40px rgba(21, 18, 12, 0.12);
        --radius-lg: 22px;
        --radius-md: 16px;
        --radius-sm: 12px;
    }

    .learning-page {
        position: relative;
        padding: 170px 0 110px;
        background: radial-gradient(circle at 15% 10%, rgba(240, 106, 63, 0.12), transparent 45%),
            radial-gradient(circle at 80% 0%, rgba(15, 124, 127, 0.12), transparent 40%),
            linear-gradient(180deg, #fff8f1 0%, #f9fbff 55%, #ffffff 100%);
        color: var(--ink);
        text-align: left;
        overflow: hidden;
    }

    .learning-page::before,
    .learning-page::after {
        content: "";
        position: absolute;
        width: 320px;
        height: 320px;
        border-radius: 999px;
        filter: blur(0px);
        opacity: 0.2;
        z-index: 0;
    }

    .learning-page::before {
        background: #f7c7a9;
        top: -80px;
        right: -60px;
    }

    .learning-page::after {
        background: #9ad7d9;
        bottom: -120px;
        left: -60px;
    }

    .learning-page .container {
        position: relative;
        z-index: 1;
        max-width: 1120px;
    }

    .learning-page h2 {
        font-size: clamp(32px, 4vw, 46px);
        text-align: center;
        letter-spacing: 0.5px;
        margin-bottom: 20px;
    }

    .learning-page h3 {
        font-size: clamp(22px, 2.4vw, 30px);
        margin-bottom: 16px;
        text-align: center;
    }

    .learning-page form {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: center;
        margin: 28px auto 36px;
        padding: 18px;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.85);
        box-shadow: var(--shadow);
        border: 1px solid rgba(29, 26, 20, 0.08);
        max-width: 680px;
    }

    .learning-page input[type="text"] {
        flex: 1 1 320px;
        border-radius: 999px;
        border: 1px solid rgba(29, 26, 20, 0.15);
        padding: 12px 18px;
        font-size: 15px;
        background: #fff;
    }

    .learning-page input[type="text"]:focus {
        outline: none;
        border-color: rgba(240, 106, 63, 0.7);
        box-shadow: 0 0 0 3px rgba(240, 106, 63, 0.15);
    }

    .learning-button {
        border: none;
        border-radius: 999px;
        padding: 12px 22px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(135deg, #f06a3f, #f08d4f);
        box-shadow: 0 12px 20px rgba(240, 106, 63, 0.25);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .learning-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 26px rgba(240, 106, 63, 0.3);
    }

    .learning-sign {
        width: min(220px, 70vw);
        margin: 18px auto 10px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(29, 26, 20, 0.12);
        box-shadow: var(--shadow);
        background: #fff;
        padding: 10px;
    }

    .learning-video {
        border-radius: var(--radius-md);
        border: 1px solid rgba(29, 26, 20, 0.12);
        box-shadow: var(--shadow);
        margin-top: 12px;
        background: #fff;
    }

    .learning-feedback {
        font-size: 18px;
        font-weight: 600;
        margin-top: 14px;
        padding: 10px 16px;
        border-radius: 999px;
        display: inline-block;
        background: rgba(15, 124, 127, 0.12);
        color: var(--ink);
    }

    .learning-cards {
        margin-top: 56px;
    }

    .learning-cards-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 22px;
    }

    .learning-card {
        background: var(--paper);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(29, 26, 20, 0.08);
        padding: 20px;
        text-align: left;
        box-shadow: var(--shadow);
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 12px;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        animation: rise 0.7s ease both;
    }

    .learning-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 24px 48px rgba(21, 18, 12, 0.16);
    }

    .learning-card-image {
        width: 100%;
        height: 160px;
        object-fit: cover;
        border-radius: var(--radius-md);
    }

    .learning-card h4,
    .learning-event h4 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }

    .learning-card p,
    .learning-event p {
        margin: 0;
        color: var(--muted);
        line-height: 1.6;
    }

    .learning-card a,
    .learning-event a {
        margin-top: auto;
        color: var(--teal);
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .learning-card a::after,
    .learning-event a::after {
        content: "â†’";
        font-size: 16px;
    }

    .learning-events {
        margin-top: 60px;
        text-align: left;
    }

    .learning-events-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 22px;
    }

    .learning-event {
        background: #ffffff;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(29, 26, 20, 0.08);
        padding: 20px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 12px;
        height: 100%;
        animation: rise 0.8s ease both;
    }

    .learning-event-meta {
        font-size: 13px;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        color: rgba(29, 26, 20, 0.5);
    }

    .event-modal {
        position: fixed;
        inset: 0;
        background: rgba(16, 18, 26, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .event-modal.is-open {
        display: flex;
    }

    .event-modal-card {
        background: #ffffff;
        border-radius: var(--radius-lg);
        padding: 20px;
        width: min(520px, 92vw);
        box-shadow: var(--shadow);
    }

    .event-modal-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 6px;
    }

    .event-modal-meta {
        font-size: 13px;
        color: rgba(29, 26, 20, 0.6);
        margin-bottom: 10px;
    }

    .event-modal-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 14px;
    }

    .event-modal-btn {
        background: #f4511e;
        color: #ffffff;
        border: 0;
        border-radius: 12px;
        padding: 8px 14px;
        font-weight: 600;
        cursor: pointer;
    }

    .learning-map {
        margin-top: 60px;
        text-align: left;
    }

    #events-map {
        width: 100%;
        height: 380px;
        min-height: 360px;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(29, 26, 20, 0.12);
        overflow: hidden;
        box-shadow: var(--shadow);
        background: #fff;
        animation: rise 0.9s ease both;
    }

    @keyframes rise {
        from {
            opacity: 0;
            transform: translateY(14px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 991px) {
        .learning-cards-grid,
        .learning-events-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .learning-page { padding: 150px 0 90px; }
    }

    @media (max-width: 640px) {
        .learning-cards-grid,
        .learning-events-grid { grid-template-columns: 1fr; }
        .learning-page form { margin: 20px auto 28px; }
        .learning-page h2 { font-size: 30px; }
    }

</style>
{% endblock %}

{% block content %}
<section class="learning-page">
    <div class="container">
        <h2>{% trans "Learning Mode - Sign Language" %}</h2>

        <form method="post">
            {% csrf_token %}
            <input type="text" name="word_input" placeholder="{% trans "Type a word (Arabic or Latin)" %}">
            <button type="submit" class="learning-button">{% trans "Choose word" %}</button>
        </form>

        {% if sign_image %}
            <h3>{% trans "Word" %}: {{ word }}</h3>
            <img src="{{ sign_image }}" class="learning-sign" alt="{% trans "Sign for" %} {{ word }}">
            <div>
                <button id="checkGesture" class="learning-button">{% trans "I made the sign" %}</button>
            </div>

            <video id="video" width="400" height="300" autoplay muted playsinline class="learning-video"></video>
            <div id="feedback" class="learning-feedback"></div>
        {% endif %}

        <div class="learning-cards">
            <h3>{% trans "Learning Tips & Videos" %}</h3>
            <div class="learning-cards-grid">
                <div class="learning-card">
                    <img src="{% static 'assets/images/ecole.jpg' %}" alt="{% trans "AMIDEAST Tunisia learning session" %}" class="learning-card-image">
                    <h4>{% trans "AMIDEAST Tunisia" %}</h4>
                    <p>{% trans "AMIDEAST Tunisia hosts a group of young hearing-impaired learners in their first English session using Tunisian Sign Language." %}</p>
                    <p>{% trans "Ms. Manel Bergaoui initiated the program to make learning inclusive and accessible." %}</p>
                    <a href="https://share.google/4py17L6yHNx0qklOu">{% trans "More information" %}</a>
                </div>
                <div class="learning-card">
                    <img src="{% static 'assets/images/image.jpg' %}" alt="{% trans "Deaf association in Tunisia" %}" class="learning-card-image">
                    <h4>{% trans "Workplace Communication" %}</h4>
                    <p>{% trans "Common workplace signs to help teams collaborate and share instructions clearly." %}</p>
                    <a href="https://jamaity.org/opportunity/association-voix-sourds-tunisie-interpretes-langue-signes/">{% trans "More information" %}</a>
                </div>
                <div class="learning-card">
                    <img src="{% static 'assets/images/transport.jpg' %}" alt="{% trans "Transport and travel in Tunisia" %}" class="learning-card-image">
                    <h4>{% trans "Transport & Travel" %}</h4>
                    <p>{% trans "Useful signs for stations, tickets, directions, and daily transport in Tunisia." %}</p>
                    <a href="https://floteuil.com/2026/01/27/voyager-sourd-les-outils-indispensables-pour-un-voyage-sans-stress/?srsltid=AfmBOopKB2Gs0-rihJnaxBpzBJXxkh6MlbYp9nIbgqBtH8cdQNCd2N1S">{% trans "More information" %}</a>
                </div>
            </div>
        </div>

        <div class="learning-events">
            <h3>{% trans "Upcoming Events" %}</h3>
            <div class="learning-events-grid">
                <div class="learning-event" data-scroll-reveal="enter bottom move 20px over 0.6s after 0.1s">
                    <h4>{% trans "TSL Basics Workshop" %}</h4>
                    <div class="learning-event-meta">{% trans "March 12, 2026 - Tunis" %}</div>
                    <p>{% trans "Intro session for families and educators to learn everyday TSL signs." %}</p>
                    <a href="#" class="event-details" data-title="{% trans "TSL Basics Workshop" %}" data-meta="{% trans "March 12, 2026 - Tunis" %}" data-desc="{% trans "Intro session for families and educators to learn everyday TSL signs." %}">{% trans "View details" %}</a>
                </div>
                <div class="learning-event" data-scroll-reveal="enter bottom move 20px over 0.6s after 0.2s">
                    <h4>{% trans "Inclusive Classroom Day" %}</h4>
                    <div class="learning-event-meta">{% trans "April 5, 2026 - Sousse" %}</div>
                    <p>{% trans "Activities and tips for supporting Deaf learners in Tunisian schools." %}</p>
                    <a href="#" class="event-details" data-title="{% trans "Inclusive Classroom Day" %}" data-meta="{% trans "April 5, 2026 - Sousse" %}" data-desc="{% trans "Activities and tips for supporting Deaf learners in Tunisian schools." %}">{% trans "View details" %}</a>
                </div>
                <div class="learning-event" data-scroll-reveal="enter bottom move 20px over 0.6s after 0.3s">
                    <h4>{% trans "Transport Access Meetup" %}</h4>
                    <div class="learning-event-meta">{% trans "May 2, 2026 - Sfax" %}</div>
                    <p>{% trans "Community meetup focused on accessible travel and public transport signs." %}</p>
                    <a href="#" class="event-details" data-title="{% trans "Transport Access Meetup" %}" data-meta="{% trans "May 2, 2026 - Sfax" %}" data-desc="{% trans "Community meetup focused on accessible travel and public transport signs." %}">{% trans "View details" %}</a>
                </div>
            </div>
        </div>

        <div class="learning-map">
            <h3>{% trans "Events Map" %}</h3>
            <div id="events-map" ></div>
        </div>
    </div>
</section>

<div class="event-modal" id="eventModal" aria-hidden="true">
    <div class="event-modal-card" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle">
        <div class="event-modal-title" id="eventModalTitle"></div>
        <div class="event-modal-meta" id="eventModalMeta"></div>
        <div id="eventModalDesc"></div>
        <div class="event-modal-actions">
            <button type="button" class="event-modal-btn" id="eventModalClose">{% trans "Close" %}</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if sign_image %}
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js"></script>

<script>
        const videoElement = document.getElementById('video');
        const feedback = document.getElementById('feedback');
        const checkBtn = document.getElementById('checkGesture');
        const referenceLandmarks = {{ reference_landmarks|default:"null"|safe }}; // landmarks de ton mot

        let lastDetected = false;
        let lastScore = null;
        let lastGestureOk = false;
        const strictThreshold = 0.12;

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`
        });
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 0,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        function normalizeLandmarks(landmarks) {
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            landmarks.forEach(p => {
                minX = Math.min(minX, p.x);
                minY = Math.min(minY, p.y);
                maxX = Math.max(maxX, p.x);
                maxY = Math.max(maxY, p.y);
            });
            const scale = Math.max(maxX - minX, maxY - minY) || 1;
            return landmarks.map(p => ({ x: (p.x - minX)/scale, y: (p.y - minY)/scale }));
        }

        function compareHands(user, reference) {
            if (!Array.isArray(user) || !Array.isArray(reference)) return null;
            if (user.length !== reference.length) return null;
            const u = normalizeLandmarks(user);
            const r = normalizeLandmarks(reference);
            let total = 0;
            for (let i = 0; i < u.length; i++) {
                const dx = u[i].x - r[i].x;
                const dy = u[i].y - r[i].y;
                total += Math.sqrt(dx*dx + dy*dy);
            }
            return total / u.length;
        }

        hands.onResults(results => {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                lastDetected = false;
                lastGestureOk = false;
                return;
            }

            lastDetected = true;
            const landmarks = results.multiHandLandmarks[0].map(lm => ({ x: lm.x, y: lm.y }));

            if (Array.isArray(referenceLandmarks) && referenceLandmarks.length === landmarks.length) {
                const avg = compareHands(landmarks, referenceLandmarks);
                lastScore = avg;
                lastGestureOk = avg !== null && avg < strictThreshold;
            } else {
                lastScore = null;
                lastGestureOk = false;
            }
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 400,
            height: 300
        });
        camera.start().catch(err => {
            console.error(err);
            feedback.innerHTML = '{% trans "Camera blocked or unavailable" %}';
        });

        checkBtn.onclick = () => {
            if (!lastDetected) {
                feedback.innerHTML = '{% trans "Hand not detected" %}';
                feedback.style.color = 'red';
                return;
            }
            if (!Array.isArray(referenceLandmarks) || referenceLandmarks.length === 0) {
                feedback.innerHTML = '{% trans "No reference for this word" %}';
                feedback.style.color = 'red';
                return;
            }
            if (lastGestureOk) {
                feedback.innerHTML = '{% trans "Bravo!" %}';
                feedback.style.color = 'green';
            } else if (lastScore > 0.25) {
                feedback.innerHTML = '{% trans "Try again" %}';
                feedback.style.color = 'red';
            } else {
                feedback.innerHTML = '{% trans "Almost correct, adjust your sign" %}';
                feedback.style.color = 'orange';
            }
        };
</script>
{% endif %}

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("eventModal");
    const modalTitle = document.getElementById("eventModalTitle");
    const modalMeta = document.getElementById("eventModalMeta");
    const modalDesc = document.getElementById("eventModalDesc");
    const modalClose = document.getElementById("eventModalClose");
    const detailLinks = document.querySelectorAll(".event-details");

    function openModal(title, meta, desc) {
        modalTitle.textContent = title || "";
        modalMeta.textContent = meta || "";
        modalDesc.textContent = desc || "";
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
    }

    detailLinks.forEach((link) => {
        link.addEventListener("click", (event) => {
            event.preventDefault();
            openModal(link.dataset.title, link.dataset.meta, link.dataset.desc);
        });
    });

    if (modalClose) {
        modalClose.addEventListener("click", closeModal);
    }

    modal.addEventListener("click", (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });

    const mapEl = document.getElementById('events-map');
    if (!mapEl) return;

    const map = L.map('events-map').setView([34.5, 10.0], 6.5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const events = [
        { title: '{% trans "TSL Basics Workshop" %}', coords: [36.8065, 10.1815] },
        { title: '{% trans "Inclusive Classroom Day" %}', coords: [35.8245, 10.6346] },
        { title: '{% trans "Transport Access Meetup" %}', coords: [34.7406, 10.7603] }
    ];

    events.forEach(e => {
        L.marker(e.coords).addTo(map).bindPopup(e.title);
    });

    // ðŸ”¥ LE FIX MAGIQUE
    setTimeout(() => {
        map.invalidateSize();
    }, 500);

    window.addEventListener('resize', () => {
        map.invalidateSize();
    });
});
</script>

{% endblock %}
