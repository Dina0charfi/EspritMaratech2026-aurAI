{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Sign In" %}{% endblock %}

{% block css %}
<style>
.auth-page { padding-top: 140px; padding-bottom: 80px; }
.auth-card { background: rgba(255,255,255,0.9); border-radius: 20px; padding: 28px; border:1px solid rgba(16,18,26,0.12); box-shadow:0 18px 40px rgba(16,18,26,0.12);}
.auth-title { font-size:28px; font-weight:700; margin-bottom:10px;}
.auth-sub { color: rgba(16,18,26,0.7); margin-bottom:20px;}
.auth-input { width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(16,18,26,0.12); margin-bottom:12px;}
.auth-actions { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-top:10px;}
.auth-btn { background:#f4511e; color:#fff; border:0; border-radius:12px; padding:10px 16px; font-weight:600;}
.auth-link { color:#f4511e; text-decoration:none; font-weight:600;}
.face-modal {
    position: fixed;
    inset: 0;
    background: rgba(16, 18, 26, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}
.face-modal.is-open { display: flex; }
.face-modal-card {
    background: #ffffff;
    border-radius: 18px;
    padding: 18px;
    width: min(520px, 92vw);
    box-shadow: 0 24px 50px rgba(16, 18, 26, 0.18);
}
.face-modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
.face-video {
    width: 100%;
    border-radius: 12px;
    background: #10121a;
    aspect-ratio: 4 / 3;
    object-fit: cover;
}
.face-modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 12px;
}
.face-secondary-btn {
    background: #ffffff;
    color: #10121a;
    border: 1px solid rgba(16, 18, 26, 0.2);
    border-radius: 12px;
    padding: 10px 16px;
    font-weight: 600;
}
.face-hint { color: rgba(16, 18, 26, 0.65); font-size: 12px; margin-top: 8px; }
</style>
{% endblock %}

{% block content %}
<section class="auth-page">
<div class="container">
<div class="row">
<div class="col-lg-5 offset-lg-3">
<div class="auth-card">
<h1 class="auth-title">{% trans "Sign In" %}</h1>
<p class="auth-sub">{% trans "Sign in to access Tunisian Sign Language tools." %}</p>

{% if error %}
  <div style="color:#b00020; margin-bottom:12px; font-weight:600;">{{ error }}</div>
{% endif %}

<form method="post">
  {% csrf_token %}
    <input type="email" name="email" class="auth-input" placeholder="{% trans "Email address" %}" required>
    <input type="password" name="password" class="auth-input" placeholder="{% trans "Password" %}" required>
  <div class="auth-actions">
    <button type="submit" class="auth-btn">{% trans "Sign In" %}</button>
    <a href="/signup/" class="auth-link">{% trans "Create an account" %}</a>
  </div>
</form>

<hr style="margin:20px 0;">


</div>
</div>
</div>
</div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Read the CSRF cookie for POST requests.
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    const faceBtn = document.getElementById("faceIdLogin");
    const faceMsg = document.getElementById("faceIdMessage");
    const faceModal = document.getElementById("faceModal");
    const faceVideo = document.getElementById("faceVideo");
    const faceCanvas = document.getElementById("faceCanvas");
    const faceCancel = document.getElementById("faceCancel");
    const faceCapture = document.getElementById("faceCapture");
    let faceStream = null;

    // Open the front camera for live capture.
    async function startFaceCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error("{% trans "Camera access is not supported in this browser." %}");
        }
        faceStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
        faceVideo.srcObject = faceStream;
        await faceVideo.play();
    }

    // Stop camera stream when the modal closes.
    function stopFaceCamera() {
        if (faceStream) {
            faceStream.getTracks().forEach((track) => track.stop());
            faceStream = null;
        }
        faceVideo.srcObject = null;
    }

    // Show capture modal.
    function openFaceModal() {
        faceModal.classList.add("is-open");
        faceModal.setAttribute("aria-hidden", "false");
    }

    // Hide capture modal and cleanup.
    function closeFaceModal() {
        faceModal.classList.remove("is-open");
        faceModal.setAttribute("aria-hidden", "true");
        stopFaceCamera();
    }

    if (faceBtn) {
        faceBtn.addEventListener("click", async () => {
            faceMsg.textContent = "";
            const emailField = document.querySelector("input[name='email']");
            const email = emailField ? emailField.value.trim() : "";
            if (!email) {
                faceMsg.textContent = "{% trans "Enter your email first." %}";
                faceMsg.style.color = "#b00020";
                return;
            }
            try {
                openFaceModal();
                await startFaceCamera();
            } catch (err) {
                faceMsg.textContent = err.message || "{% trans "Unable to open camera." %}";
                faceMsg.style.color = "#b00020";
                closeFaceModal();
            }
        });
    }

    if (faceCancel) {
        faceCancel.addEventListener("click", () => {
            closeFaceModal();
        });
    }

    if (faceCapture) {
        faceCapture.addEventListener("click", async () => {
            const emailField = document.querySelector("input[name='email']");
            const email = emailField ? emailField.value.trim() : "";
            if (!email) {
                faceMsg.textContent = "{% trans "Enter your email first." %}";
                faceMsg.style.color = "#b00020";
                closeFaceModal();
                return;
            }

            faceCapture.disabled = true;
            faceMsg.textContent = "{% trans "Verifying face..." %}";
            faceMsg.style.color = "#10121a";

            try {
                const width = faceVideo.videoWidth || 640;
                const height = faceVideo.videoHeight || 480;
                faceCanvas.width = width;
                faceCanvas.height = height;
                // Capture a still frame and send to the server for verification.
                const ctx = faceCanvas.getContext("2d");
                ctx.drawImage(faceVideo, 0, 0, width, height);
                const imageData = faceCanvas.toDataURL("image/jpeg", 0.9);

                const csrfToken = getCookie("csrftoken");
                const verifyRes = await fetch("/face/verify/", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken
                    },
                    body: JSON.stringify({ email, image: imageData })
                });
                const verify = await verifyRes.json();
                if (verify.error) {
                    faceMsg.textContent = verify.error;
                    faceMsg.style.color = "#b00020";
                    return;
                }

                window.location.href = "/";
            } catch (err) {
                faceMsg.textContent = err.message || "{% trans "Face verification failed." %}";
                faceMsg.style.color = "#b00020";
            } finally {
                faceCapture.disabled = false;
                closeFaceModal();
            }
        });
    }
</script>
{% endblock %}
